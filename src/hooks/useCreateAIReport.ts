
import { useMutation } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { useClinica } from '@/contexts/ClinicaContext';
import { toast } from 'sonner';
import type { CreateReportData, ReportRequestPayload } from '@/types/aiReports';

/**
 * Hook para cria√ß√£o de relat√≥rios de IA
 * 
 * O que faz:
 * - Gerencia o processo de cria√ß√£o de novos relat√≥rios
 * - Cria registro na tabela ai_reports
 * - Chama a Edge Function otimizada que envia payload m√≠nimo para o n8n
 * - Gerencia estados de loading e erro
 * - Exibe toasts de feedback para o usu√°rio
 * - Suporte a modo administrador com clinicaId espec√≠fica
 * 
 * Onde √© usado:
 * - No hook principal useAIReport
 * - Componentes que precisam criar relat√≥rios
 */
export const useCreateAIReport = (refetchReports: () => void, targetClinicaId?: string) => {
  const { clinicaId: contextClinicaId } = useClinica();

  // Mutation para criar um novo relat√≥rio
  const createReportMutation = useMutation({
    mutationFn: async (reportData: CreateReportData) => {
      // Usar clinicaId fornecida (admin) ou do contexto (usu√°rio normal)
      const effectiveClinicaId = targetClinicaId || contextClinicaId;
      
      if (!effectiveClinicaId) {
        throw new Error('ID da cl√≠nica n√£o encontrado');
      }

      console.log('üìä Criando novo relat√≥rio para cl√≠nica:', effectiveClinicaId, reportData);

      // 1. Criar registro na tabela ai_reports
      const { data: reportRecord, error: createError } = await supabase
        .from('ai_reports')
        .insert({
          clinica_id: effectiveClinicaId,
          start_date: reportData.period_start.toISOString(),
          end_date: reportData.period_end.toISOString(),
          delivery_method: reportData.delivery_method,
          phone_number: reportData.recipient_phone_number,
          status: 'pending'
        })
        .select()
        .single();

      if (createError || !reportRecord) {
        console.error('Erro ao criar registro do relat√≥rio:', createError);
        throw createError;
      }

      console.log('‚úÖ Registro do relat√≥rio criado:', reportRecord.id);

      // 2. Preparar payload m√≠nimo para a Edge Function
      const payload: ReportRequestPayload = {
        clinica_id: effectiveClinicaId,
        start_date: reportData.period_start.toISOString(),
        end_date: reportData.period_end.toISOString(),
        delivery_method: reportData.delivery_method,
        recipient_phone_number: reportData.recipient_phone_number,
        report_request_id: reportRecord.id
      };

      // 3. Chamar a Edge Function otimizada
      const { data: functionResponse, error: functionError } = await supabase.functions.invoke('generate-ai-report', {
        body: payload
      });

      if (functionError) {
        console.error('Erro na Edge Function:', functionError);
        
        // Atualizar status para falha
        await supabase
          .from('ai_reports')
          .update({ 
            status: 'failed',
            error_message: functionError.message || 'Erro na Edge Function'
          })
          .eq('id', reportRecord.id);
        
        throw functionError;
      }

      console.log('‚úÖ Edge Function executada com sucesso:', functionResponse);
      return reportRecord;
    },
    onSuccess: (data) => {
      toast.success('Relat√≥rio solicitado com sucesso! O processamento foi iniciado no n8n.');
      refetchReports();
    },
    onError: (error) => {
      console.error('‚ùå Erro ao criar relat√≥rio:', error);
      toast.error('Erro ao solicitar relat√≥rio. Tente novamente.');
    }
  });

  return {
    createReport: createReportMutation.mutate,
    isCreating: createReportMutation.isPending
  };
};
